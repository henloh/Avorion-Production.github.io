sap.ui.define(["sap/m/MessageBox","./BaseController","../model/formatter","sap/ui/model/json/JSONModel","./Types","sap/m/Panel","sap/m/Select","sap/ui/core/Item","sap/m/Title","sap/m/Button","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/util/File"],function(t,e,r,o,a,s,i,c,n,l,d,h,g,p){function u(t){return t&&t.__esModule&&typeof t.default!=="undefined"?t.default:t}const f=u(e);const v=u(r);const y=a["Factory"];const m=a["Game"];const P=a["Product"];class F extends P{constructor(t,e,r){super(t.Name,t.Dangerous,t.Illegal,t.AvgPrice,t.Level,t.Customers,t.Manufacturer);this.parent=r;this.game=e;this.factoryOptions=[];this.subs={}}getId(){if(this.parent.getId){return this.parent.getId()+"/"+this.Name.replace(/\s/g,"")}else{return this.Name.replace(/\s/g,"")}}getActiveFactory(){var t=[];for(const e of this.factoryOptions){if(e.active){t=t.concat(e.getActiveSubs());t.indexOf(e.Name)===-1?t.push(e.Name):null;return t}}}getExportFactory(){var t={};for(const e of this.factoryOptions){if(e.active){t.Name=e.Name;t.requiredProducts=[];for(const r of e.requiredProducts){t.requiredProducts.push({Name:r.Name,Factory:r.getExportFactory()})}}}return t}getSubGoods(){var t=[];for(const e of this.factoryOptions){t=t.concat(e.getAllGoods())}return t}setActiveFactory(t){if(!(this.factoryOptions.length>0))return;for(const r of this.factoryOptions){r.active=false;if(r.Name==t){r.active=true;if(this.factoryOptions.length>1){var e=this.control.getContent()[0];e.setSelectedKey(r.Name.replace(/\s/g,""))}}}}setFactoryActive(){if(this.factoryOptions.length==1){this.factoryOptions[0].active=true;return this.factoryOptions[0]}else if(this.factoryOptions.length>1){var t=this.factoryOptions[0];for(const r of this.factoryOptions){var e=t.getMaterialLevelCombined();if(r.getMaterialLevelCombined()<e){t=r}}t.active=true;return t}}setActiveFactoryRecursiv(t,e){if(this.Name==t){this.setActiveFactory(e);return}if(this.factoryOptions.length>0){for(const r of this.factoryOptions){r.checkMaterialList(t,e)}}}buildControl(t){this.id=this.getId();this.control=new s(this.Name.replace(/\s/g,"")+this.game.getPanelId(),{expanded:false,expandable:true,headerText:`{View>/game/subs/${this.id}/Name}`});this.control.addStyleClass("avlevel"+t);this.game.deathZone.push(this.control);t++;var e=this.game.getFactoriesForProduct(this.Name);try{for(const t of e){var r=new b(t,this.game,this);this.factoryOptions.push(r)}}catch(t){console.warn("No factory for "+this.Name);this.control.setExpandable(false);this.control.addStyleClass("dontShowContent")}if(this.factoryOptions.length==1){this.factoryOptions[0].buildControl(this.Level,t);this.control.addContent(this.factoryOptions[0].control);this[this.factoryOptions[0].Name.replace(/\s/g,"")]=this.factoryOptions[0];this.setFactoryActive()}else if(this.factoryOptions.length>1){var o=new i(this.Name.replace(/\s/g,"")+this.game.getPanelId(),{selectedItem:`View>/game/subs/${this.id}/activeChild`,items:{path:`View>/game/subs/${this.id}/factoryOptions`,template:new c({text:"{View>Name}",key:"{View>selectid}"}),templateShareable:true},change:this.game.that.selectFactory});this.game.deathZone.push(o);var a=this.setFactoryActive();o.setSelectedKey(a.Name.replace(/\s/g,""));var n=new l(this.Name.replace(/\s/g,"")+this.game.getPanelId(),{text:`Apply to all {View>/game/subs/${this.id}/Name} facilities.`,press:this.game.that.setBaseFactory}).addStyleClass("sapUiSmallMarginBegin");this.game.deathZone.push(n);this.control.addContent(o);this.control.addContent(n);for(var d of this.factoryOptions){d.buildControl(this.Level,t);this[d.Name.replace(/\s/g,"")]=d;this.control.addContent(d.control)}}}}class b extends y{constructor(t,e,r){super(t.Name,t.ProductionCap,t.Cost,t.Products,t.Materials);this.parent=r;this.game=e;this.selectid=t.Name.replace(/\s/g,"");this.requiredProducts=[];this.active=false;this.subs={}}getId(){return this.parent.getId()+"/"+this.Name.replace(/\s/g,"")}getMaterialLevelCombined(){var t=0;for(const e of this.Materials){t+=this.game.getProduct(e).Level}return t}getAllGoods(){var t=[];for(const e of this.requiredProducts){t.push(e);t=t.concat(e.getSubGoods())}return t}getActiveSubs(){var t=[];for(const e of this.requiredProducts){t=t.concat(e.getActiveFactory())}return t}checkMaterialList(t,e){if(this.Products.indexOf(t)>=0)this.active=this.Name==e;for(const r of this.requiredProducts){if(r.Name==t){r.setActiveFactory(e)}r.setActiveFactoryRecursiv(t,e)}}buildControl(t,e){this.id=this.getId();if(t==0){this.control=new n(this.Name.replace(/\s/g,"")+this.game.getPanelId(),{width:"100%",visible:`{View>/game/subs/${this.id}/active}`,text:`{View>/game/subs/${this.id}/Name}`})}else{this.control=new s(this.Name.replace(/\s/g,"")+this.game.getPanelId(),{expanded:true,expandable:true,visible:`{View>/game/subs/${this.id}/active}`,headerText:`{View>/game/subs/${this.id}/Name}`});var r=this.game.getMaterialsForFactory(this.Name);for(const t of r){var o=new F(t,this.game,this);this.requiredProducts.push(o)}for(var a of this.requiredProducts){a.buildControl(e);this.control.addContent(a.control);this[a.Name.replace(/\s/g,"")]=a}}this.game.deathZone.push(this.control)}}class N extends m{constructor(t,e){super(t,e);this.deathZone=[];this.availableGoods=[];this.reqFactories=[];this.prodTree=[];this.products=[];this.panelCount=0;this.subs={}}setTargetFactory(t){this.targetFactory=this.getFactory(t);this.products=this.getMaterialsForFactory(this.targetFactory.Name);for(const t of this.products){var e=new F(t,this,this);this.prodTree.push(e)}for(var r of this.prodTree){r.buildControl(0);this.subs[r.id]=r}return this.subs}clearDeathZone(){for(const t of this.deathZone){t.destroy()}}getActiveFactories(){var t=[];for(var e of this.prodTree){t=t.concat(e.getActiveFactory())}t=[...new Set(t)];for(let e=t.length-1;e>-1;e--){const r=t[e];if(r==undefined)t.splice(e,1)}return t}getExportTree(){var t={};for(var e of this.prodTree){t[e.Name]={Name:e.Name,Factory:e.getExportFactory()}}return t}setBaseFactory(t,e){for(var r in this.subs){this.subs[r].setActiveFactoryRecursiv(t,e)}}setAvailableGood(t){this.availableGoods.push(t);var e=[];for(const t of this.prodTree){e.push(t);e=e.concat(t.getSubGoods())}for(const r of e){if(r.Name==t){r.control.addStyleClass("dontShowContent");r.control.setExpandable(false);for(const t of r.factoryOptions){t.active=false}}}}getPanelId(){this.panelCount++;return this.panelCount}}class w extends f{formatter=v;onInit(){var t=new o;t.setData({TargetFactory:"",products:[]});this.getView().setModel(t,"View");this.getRouter().getRoute("productionLine").attachPatternMatched(this.onPatternMatched,this);var e=this.byId("targetFactoryInput");e.setFilterFunction(function(t,e){return e.getText().match(new RegExp("^"+t,"i"))})}async generateProductionLine(t){var e=this;var r=this.getView();var o=this.getModel("View");var a;try{a=o.getProperty("/game");if(a){a.clearDeathZone()}a=new N(this.getModel("GoodModel").getProperty("/Goods"),this.getModel("FactorieModel").getProperty("/Factories"))}catch(t){console.error(t)}a.that=e;var s=r.byId("targetFactoryInput").getValue();o.setProperty("/products",a.getProductsFromFactory(s));a.setTargetFactory(s);for(var i in a.subs){e.byId("DetailedProdList").addItem(a.subs[i].control)}o.setProperty("/game",a);o.setProperty("/requiredFactories",a.getActiveFactories().sort())}selectFactory(t){var e=t.getSource();var r=t.getParameters().selectedItem;var o=this.getModel("View");var a=e.getBindingPath("items");var s=o.getProperty(a);for(var i=0;i<s.length;i++){o.setProperty(a+`/${i}/active`,false);if(o.getProperty(a+`/${i}/Name`)==r.getText()){o.setProperty(a+`/${i}/active`,true)}}var c=o.getProperty("/game");o.setProperty("/requiredFactories",c.getActiveFactories().sort())}setBaseFactory(t){var e=this.getModel("View");var r=e.getProperty("/game");var o=t.getSource();var a=o.getBindingPath("text");var s=e.getProperty(a);var i=e.getProperty(a.substring(0,a.lastIndexOf("/")));i=i.control.getContent()[0].getSelectedItem().getText();r.setBaseFactory(s,i);e.setProperty("/game",r);e.setProperty("/requiredFactories",r.getActiveFactories().sort())}addAvailableGood(t){var e=this.getView();var r=this;try{r.selectDialog.open("")}catch(t){d.load({id:"speccalDialog",name:"de.henloh.prodts.view.Dialog",controller:this}).then(function(t){t.setModel(e.getModel("GoodModel"));t.open("");r.selectDialog=t}.bind(this))}}onDialogClose(t){var e=t.getParameter("selectedContexts");var r=this.getModel("View");var o=r.getProperty("/game");if(e&&e.length){e.map(function(t){try{o.setAvailableGood(t.getObject().Name)}catch(t){console.warn(t)}});r.setProperty("/availableGoods",o.availableGoods);r.setProperty("/game",o)}t.getSource().getBinding("items").filter([]);r.setProperty("/requiredFactories",o.getActiveFactories().sort())}onSearch(t){var e=t.getParameter("value");var r=new h("Name",g.Contains,e);var o=t.getParameter("itemsBinding");o.filter([r])}handleDownloadPress(){var t=this.getModel("View");var e=t.getProperty("/game");var r={targetFactory:t.getProperty("/TargetFactory"),availableGoods:t.getProperty("/availableGoods"),requiredFactories:t.getProperty("/requiredFactories"),products:t.getProperty("/products"),basicTree:e.getExportTree()};var o=JSON.stringify(r);p.save(o,"data","json","application/json","utf-8")}openUploadDialog(t){var e=this;try{e.importDialog.open()}catch(t){d.load({id:"speccalDialog2",name:"de.henloh.prodts.view.Import",controller:this}).then(function(t){t.open();e.importDialog=t}.bind(this))}}closeDialog(t){this.importDialog.close()}handleUploadPress(e){var r=e.getParameters().item.getFileObject();var o=this;var a=new FileReader;var s=this.getModel("View");a.readAsText(r);a.onload=function(){var e=JSON.parse(a.result);try{s.setProperty("/TargetFactory",e.targetFactory);s.setProperty("/availableGoods",e.availableGoods);s.setProperty("/requiredFactories",e.requiredFactories);s.setProperty("/products",e.products);var r=e.basicTree;var i;i=s.getProperty("/game");if(i){i.clearDeathZone()}i=new N(o.getModel("GoodModel").getProperty("/Goods"),o.getModel("FactorieModel").getProperty("/Factories"));i.that=o;i.setTargetFactory(e.targetFactory);for(var c in i.subs){o.byId("DetailedProdList").addItem(i.subs[c].control)}s.setProperty("/game",i)}catch(e){t.show("Uploaded data does not contain a production-tree.")}}}onPatternMatched(t){}}return w});
//# sourceMappingURL=ProductionLine.controller.js.map